###
# Variables
define Flow 50 # Default Value
define Pressure 80  # Default Value
# Dont edit below this line
alias PumpIn d0
alias PumpOut d1
alias DisplayLed d2 # Optional 
alias DialMode d3 # Optional, recommended
alias DialFlow d4 # Optional
alias DialPressure d5 # Optional
# Internal Variables
alias GasSensorHash r2
move GasSensorHash -1252983604
alias Temp1 r0 # Temporary data 1
alias Temp2 r1 # Temporary data 2
alias TargetPumpIn r3 
alias TargetPumpOut r4 
alias SetDisplayValue r5 
alias SetDisplayColor r6 
alias CurrentPressure r7 
alias TargetMode r15  
move TargetMode 1 
brdns DialMode 3
move TargetMode 0 
s DialMode Settings TargetMode
alias TargetFlow r14
move TargetFlow Flow
brdns DialFlow 2
s DialFlow Settings TargetFlow
alias TargetPressure r13
move TargetPressure Pressure
brdns DialPressure 2
s DialPressure Settings TargetPressure
loop:
bdns DialMode automatic
j dialmodepresent
j loop
dialmodepresent:
l Temp1 DialMode Settings
brne Temp1 3 6
move TargetPumpIn 100
move TargetPumpOut 0
move SetDisplayValue 3
move SetDisplayColor 4
j doit
brne Temp1 2 6
move TargetPumpIn 0
move TargetPumpOut 100
move SetDisplayValue 2
move SetDisplayColor 5
j doit
beq Temp1 1 automatic
move TargetPumpIn 0
move TargetPumpOut 0
move SetDisplayValue 0
move SetDisplayColor 2
j doit
j loop
automatic:
yield
lb CurrentPressure GasSensorHash Pressure 0
div Temp1 TargetPressure 2
brge CurrentPressure Temp1 6
move TargetPumpIn 0
move TargetPumpOut 0
move SetDisplayValue 99.1
move SetDisplayColor 10
j doit
brdns DialFlow 2
l TargetFlow DialFlow Settings
brgtz TargetFlow 6
move TargetPumpIn 0
move TargetPumpOut 0
move SetDisplayValue 99.2
move SetDisplayColor 10
j doit
brdns DialPressure 2
l TargetPressure DialPressure Settings
div Temp1 CurrentPressure TargetPressure
sub Temp1 1 Temp1
mul Temp1 Temp1 TargetFlow
# Volume In
add TargetPumpIn Temp1 TargetFlow
round TargetPumpIn TargetPumpIn
brle TargetPumpIn 100 2
move TargetPumpIn 100
# VolumeOut
sub TargetPumpOut TargetFlow Temp1
round TargetPumpOut TargetPumpOut
brge TargetPumpOut 0 2
move TargetPumpOut 0
div Temp2 TargetPumpOut 100
add SetDisplayValue TargetPumpIn Temp2
move SetDisplayColor 2
j doit
j loop
doit: 
s PumpOut Settings TargetPumpOut
s PumpIn Settings TargetPumpIn
brdns DisplayLed 3
s DisplayLed Settings SetDisplayValue
s DisplayLed Color SetDisplayColor
j loop
